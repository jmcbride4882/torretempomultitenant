// Torre Tempo - Prisma Schema
// Spanish labor law compliant time tracking system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANT & AUTH
// ============================================

model Tenant {
  id       String @id @default(uuid()) @db.Uuid
  name     String
  slug     String @unique
  timezone String @default("Europe/Madrid")
  locale   String @default("es")

  // Convenio settings
  convenioCode   String? // e.g., "30000805011981"
  maxWeeklyHours Int     @default(40)
  maxAnnualHours Int     @default(1822)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  locations Location[]
  shifts    Shift[]
  reports   Report[]
  auditLogs AuditLog[]

  @@map("tenants")
}

model User {
  id       String  @id @default(uuid()) @db.Uuid
  tenantId String? @db.Uuid
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  email        String
  passwordHash String
  firstName    String
  lastName     String
  employeeCode String?
  role         Role    @default(EMPLOYEE)
  isActive     Boolean @default(true)

  // Locale override (falls back to tenant)
  locale String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  timeEntries       TimeEntry[]
  editRequests      EditRequest[]   @relation("RequestedBy")
  approvals         EditRequest[]   @relation("ApprovedBy")
  schedules         Schedule[]
  signatures        Signature[]
  overtimeEntries   OvertimeEntry[]
  approvedOvertimes OvertimeEntry[] @relation("OvertimeApprovedBy")
  reports           Report[]

  @@unique([tenantId, email])
  @@map("users")
}

enum Role {
  GLOBAL_ADMIN
  EMPLOYEE
  MANAGER
  ADMIN
}

// ============================================
// LOCATIONS & GEOFENCING
// ============================================

model Location {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  name     String
  address  String?
  isActive Boolean @default(true)

  // Geofence (circular)
  latitude     Float?
  longitude    Float?
  radiusMeters Int?   @default(100)

  // QR settings
  qrEnabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  qrTokens    QRToken[]
  timeEntries TimeEntry[]
  shifts      Shift[]
  schedules   Schedule[]

  @@map("locations")
}

model QRToken {
  id         String   @id @default(uuid()) @db.Uuid
  locationId String   @db.Uuid
  location   Location @relation(fields: [locationId], references: [id])

  token     String    @unique @default(uuid())
  isActive  Boolean   @default(true)
  expiresAt DateTime?

  createdAt DateTime @default(now())

  @@map("qr_tokens")
}

// ============================================
// TIME TRACKING
// ============================================

model TimeEntry {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid
  userId   String @db.Uuid
  user     User   @relation(fields: [userId], references: [id])

  locationId String?   @db.Uuid
  location   Location? @relation(fields: [locationId], references: [id])

  // Core timestamps (always UTC, displayed in tenant timezone)
  clockIn  DateTime
  clockOut DateTime?

  // Break tracking (optional)
  breakMinutes Int?

  // Proof of presence
  origin    EntryOrigin @default(MANUAL)
  qrTokenId String?

  // Geolocation at clock-in/out
  clockInLat  Float?
  clockInLng  Float?
  clockOutLat Float?
  clockOutLng Float?

  // Offline sync metadata
  offlineId    String?
  syncedAt     DateTime?
  conflictFlag Boolean   @default(false)

  // Schedule integration
  scheduleId        String?   @db.Uuid
  schedule          Schedule? @relation(fields: [scheduleId], references: [id])
  validationWarning String?

  // Status
  status EntryStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  editRequests    EditRequest[]
  breaks          BreakEntry[]
  overtimeEntries OvertimeEntry[]

  @@index([tenantId, userId, clockIn])
  @@map("time_entries")
}

enum EntryOrigin {
  MANUAL // Admin/manager created
  QR // QR code scan
  GEOFENCE // Auto clock-in via geofence
  OFFLINE // Queued offline, synced later
}

enum EntryStatus {
  ACTIVE
  EDITED // Modified via approval
  DELETED // Soft delete
}

model BreakEntry {
  id          String    @id @default(uuid()) @db.Uuid
  timeEntryId String    @db.Uuid
  timeEntry   TimeEntry @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)

  startedAt DateTime
  endedAt   DateTime?

  createdAt DateTime @default(now())

  @@index([timeEntryId])
  @@map("break_entries")
}

model OvertimeEntry {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid
  userId   String @db.Uuid
  user     User   @relation(fields: [userId], references: [id])

  timeEntryId String    @db.Uuid
  timeEntry   TimeEntry @relation(fields: [timeEntryId], references: [id])

  hours Float // Overtime hours
  type  OvertimeType @default(ORDINARY)

  // Compensation
  compensationType CompensationType @default(TIME_OFF)
  compensatedAt    DateTime?

  // Approval
  approvedById String?   @db.Uuid
  approvedBy   User?     @relation("OvertimeApprovedBy", fields: [approvedById], references: [id])
  approvedAt   DateTime?

  createdAt DateTime @default(now())

  @@index([tenantId, userId, createdAt])
  @@map("overtime_entries")
}

enum OvertimeType {
  ORDINARY // Normal overtime
  FORCE_MAJEURE // Emergency/force majeure (exempt from 80h limit)
}

enum CompensationType {
  TIME_OFF // Compensated with time off (within 4 months)
  PAY // Compensated with pay (175% minimum)
}

// ============================================
// APPROVALS & AUDIT
// ============================================

model EditRequest {
  id          String    @id @default(uuid()) @db.Uuid
  timeEntryId String    @db.Uuid
  timeEntry   TimeEntry @relation(fields: [timeEntryId], references: [id])

  requestedById String @db.Uuid
  requestedBy   User   @relation("RequestedBy", fields: [requestedById], references: [id])

  // What changed
  fieldName String // e.g., "clockIn", "clockOut"
  oldValue  String
  newValue  String
  reason    String

  // Approval
  status       ApprovalStatus @default(PENDING)
  approvedById String?        @db.Uuid
  approvedBy   User?          @relation("ApprovedBy", fields: [approvedById], references: [id])
  approvalNote String?
  approvedAt   DateTime?

  createdAt DateTime @default(now())

  @@map("edit_requests")
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model AuditLog {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // What happened
  action   String // CREATE, UPDATE, DELETE, LOGIN, EXPORT, etc.
  entity   String // TimeEntry, User, Location, etc.
  entityId String? @db.Uuid

  // Who did it
  actorId    String? @db.Uuid
  actorEmail String?
  actorRole  String?

  // Details
  changes   Json?
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([tenantId, entity, entityId])
  @@map("audit_logs")
}

// ============================================
// SCHEDULING
// ============================================

model Shift {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  locationId String?   @db.Uuid
  location   Location? @relation(fields: [locationId], references: [id])

  name      String // e.g., "Morning", "Evening", "Night"
  startTime String // HH:mm format
  endTime   String // HH:mm format
  breakMins Int    @default(0)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schedules Schedule[]

  @@map("shifts")
}

model Schedule {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid

  // userId is nullable to support "open shifts" (unassigned schedules that employees can self-accept)
  userId String? @db.Uuid
  user   User?   @relation(fields: [userId], references: [id])

  shiftId String @db.Uuid
  shift   Shift  @relation(fields: [shiftId], references: [id])

  locationId String?   @db.Uuid
  location   Location? @relation(fields: [locationId], references: [id])

  date DateTime @db.Date

  // Published = visible to employee
  isPublished Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  timeEntries TimeEntry[]

  // Removed unique constraint on userId+date since userId can be null for open shifts
  // Multiple open shifts can exist for the same date
  @@index([userId, date])
  @@index([tenantId, date])
  @@map("schedules")
}

// ============================================
// REPORTS & SIGNATURES
// ============================================

model Report {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  type   ReportType
  period String // e.g., "2025-01" for monthly

  // For MONTHLY_EMPLOYEE reports, the employee this report is for
  userId String? @db.Uuid
  user   User?   @relation(fields: [userId], references: [id])

  // Generated file
  fileUrl  String?
  fileHash String? // SHA-256 for integrity

  generatedAt DateTime @default(now())

  signatures Signature[]

  @@unique([tenantId, type, period, userId])
  @@map("reports")
}

enum ReportType {
  MONTHLY_EMPLOYEE // Individual monthly report
  MONTHLY_COMPANY // Company-wide summary
  COMPLIANCE_EXPORT // For inspector
}

model Signature {
  id       String @id @default(uuid()) @db.Uuid
  reportId String @db.Uuid
  report   Report @relation(fields: [reportId], references: [id])

  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id])

  // Signature data
  imageBase64 String @db.Text

  // Acknowledgment
  acknowledgedAt DateTime @default(now())
  ipAddress      String?
  userAgent      String?

  @@unique([reportId, userId])
  @@map("signatures")
}
